<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Identity Services (OAuth) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <meta charset="UTF-8" />
  <title>Brazilian E-Commerce Analytics – BigQuery Live Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google API JS (BigQuery) -->
  <script src="https://apis.google.com/js/api.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card-bg: #020818;
      --card-border: #1f2937;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.16);
      --accent-strong: #38bdf8;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --nav-pill-bg: #0f172a;
      --nav-pill-active: #22c55e;
      --nav-pill-text: #f9fafb;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #0b1120, #020617);
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      padding: 14px 24px 8px;
      border-bottom: 1px solid #111827;
      background: linear-gradient(to right, #020617, #020617 40%, #022c22 90%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
    }

    .title-block p {
      margin: 3px 0 0;
      font-size: 11px;
      color: var(--text-sub);
    }

    #auth {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #signin-button {
      background: var(--accent-strong);
      color: #0b1120;
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.6),
                  0 10px 30px rgba(45, 212, 191, 0.25);
    }

    #signin-button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    #signout-button {
      background: #111827;
      color: var(--text-sub);
      border: 1px solid #1f2937;
    }

    .header-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .tabs {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tab-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-sub);
      margin-right: 6px;
    }

    .tab-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--nav-pill-bg);
      color: #9ca3af;
      border: 1px solid #111827;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease-out;
    }

    .tab-pill.active {
      background: var(--nav-pill-active);
      color: #022c22;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(22, 163, 74, 0.8),
                  0 10px 25px rgba(22, 163, 74, 0.4);
    }

    .tab-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .tab-pill.active span.dot {
      background: #022c22;
    }

    .year-slicer {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .year-slicer-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-sub);
    }

    .year-pill {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 4px 10px;
      font-size: 11px;
      color: #9ca3af;
      cursor: pointer;
      min-width: 48px;
      text-align: center;
      transition: all 0.18s ease-out;
    }

    .year-pill.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.6);
    }

    #status {
      font-size: 11px;
      color: var(--text-sub);
    }

    #status span {
      background: rgba(15, 23, 42, 0.9);
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }

    #status.error span {
      border-color: #b91c1c;
      background: rgba(127, 29, 29, 0.9);
      color: #fecaca;
    }

    main {
      padding: 14px 18px 40px;
      max-width: 1480px;
      margin: 0 auto;
    }

    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 1.1fr;
      grid-auto-rows: 310px;
      gap: 14px;
    }

    .grid.orders-grid {
      grid-template-columns: 1.2fr 1.1fr 1.1fr;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), var(--card-bg));
      border-radius: 12px;
      padding: 8px 10px 6px;
      border: 1px solid var(--card-border);
      display: flex;
      flex-direction: column;
      min-height: 0;
      box-shadow: 0 18px 40px rgba(15,23,42,0.82);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(15,23,42,0.9);
      margin-bottom: 3px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }

    .card-note {
      font-size: 10px;
      color: var(--text-sub);
      opacity: 0.8;
    }

    .chart {
      flex: 1;
      min-height: 0;
    }

    .card-map {
      grid-column: span 2;
      grid-row: span 2;
    }

    .chart-map {
      height: 100%;
      min-height: 360px;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }

    .kpi {
      background: radial-gradient(circle at top, rgba(22, 101, 52, 0.25), rgba(15,23,42,0.9));
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid #14532d;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kpi-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #a7f3d0;
    }

    .kpi-value {
      font-size: 17px;
      font-weight: 600;
    }

    .kpi-sub {
      font-size: 10px;
      color: var(--text-sub);
    }

    @media (max-width: 1200px) {
      .grid,
      .grid.orders-grid {
        grid-template-columns: 1fr;
        grid-auto-rows: 320px;
      }

      .card-map {
        grid-column: span 1;
        grid-row: span 1;
      }
    }

    @media (max-width: 780px) {
      header {
        padding: 10px 12px 6px;
      }
      main {
        padding: 10px 8px 28px;
      }
      .kpi-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="title-block">
        <h1>BRAZILIAN E-COMMERCE ANALYTICS</h1>
        <p>Olist BigQuery Warehouse · dbt star schema · Interactive dashboards</p>
      </div>
      <div id="auth">
        <button id="signin-button" disabled>Sign in with Google</button>
        <button id="signout-button" style="display:none;">Sign out</button>
      </div>
    </div>

    <div class="header-bottom">
      <div class="tabs">
        <span class="tab-label">Dashboards</span>
        <button class="tab-pill active" data-tab="customers">
          <span class="dot"></span> Customers
        </button>
        <button class="tab-pill" data-tab="sellers">
          <span class="dot"></span> Sellers
        </button>
        <button class="tab-pill" data-tab="orders">
          <span class="dot"></span> Orders &amp; Reviews
        </button>
      </div>

      <div class="year-slicer">
        <span class="year-slicer-label">Year</span>
        <button class="year-pill active" data-year="ALL">All</button>
        <button class="year-pill" data-year="2016">2016</button>
        <button class="year-pill" data-year="2017">2017</button>
        <button class="year-pill" data-year="2018">2018</button>
      </div>

      <div id="status"><span>Loading Google API…</span></div>
    </div>
  </header>

  <main>
    <!-- CUSTOMERS DASHBOARD -->
    <section id="dashboard-customers" class="dashboard active">
      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-label">Total Customers</div>
          <div class="kpi-value" id="kpi-cust-count">–</div>
          <div class="kpi-sub">Distinct with at least one order</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total Orders</div>
          <div class="kpi-value" id="kpi-cust-orders">–</div>
          <div class="kpi-sub">Orders with at least 1 item</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Customer States</div>
          <div class="kpi-value" id="kpi-cust-states">–</div>
          <div class="kpi-sub">Unique customer_state</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value" id="kpi-cust-revenue">–</div>
          <div class="kpi-sub">Sum gross_order_item_value (BRL)</div>
        </div>
      </div>

      <section class="grid">
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Customers by Year</div>
              <div class="card-subtitle">Distinct customers with at least one order</div>
            </div>
          </div>
          <div id="cust-by-year" class="chart"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Top 5 States by Customers</div>
              <div class="card-subtitle">Active customer base – current year filter</div>
            </div>
          </div>
          <div id="cust-top-states" class="chart"></div>
        </article>

        <article class="card card-map">
          <div class="card-header">
            <div>
              <div class="card-title">Customer Density Map</div>
              <div class="card-subtitle">
                Bubble size = number of customers per state. Year slicer applies.
              </div>
            </div>
            <div class="card-note">Tip: zoom &amp; pan to focus on Brazil.</div>
          </div>
          <div id="cust-map" class="chart chart-map"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Bottom 5 States by Customers</div>
              <div class="card-subtitle">States with smallest active base</div>
            </div>
          </div>
          <div id="cust-bottom-states" class="chart"></div>
        </article>
      </section>
    </section>

    <!-- SELLERS DASHBOARD -->
    <section id="dashboard-sellers" class="dashboard">
      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-label">Total Sellers</div>
          <div class="kpi-value" id="kpi-sellers-count">–</div>
          <div class="kpi-sub">Distinct seller_id</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Seller Cities</div>
          <div class="kpi-value" id="kpi-sellers-cities">–</div>
          <div class="kpi-sub">Unique seller_city</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Seller States</div>
          <div class="kpi-value" id="kpi-sellers-states">–</div>
          <div class="kpi-sub">Unique seller_state</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value" id="kpi-sellers-revenue">–</div>
          <div class="kpi-sub">Sum gross_order_item_value (BRL)</div>
        </div>
      </div>

      <section class="grid">
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Total Freight by Year</div>
              <div class="card-subtitle">Sum of freight_value</div>
            </div>
          </div>
          <div id="seller-freight-year" class="chart"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Revenue Trend by Year</div>
              <div class="card-subtitle">gross_order_item_value (price + freight)</div>
            </div>
          </div>
          <div id="seller-revenue-year" class="chart"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Top 10 States by Sellers</div>
              <div class="card-subtitle">Where supply is concentrated</div>
            </div>
          </div>
          <div id="seller-top-states" class="chart"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Bottom 10 States by Sellers</div>
              <div class="card-subtitle">Expansion opportunities</div>
            </div>
          </div>
          <div id="seller-bottom-states" class="chart"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Product Category Breadth</div>
              <div class="card-subtitle">Distinct product categories sold (&gt; 2 orders)</div>
            </div>
          </div>
          <div id="seller-category-breadth" class="chart"></div>
        </article>
      </section>
    </section>

    <!-- ORDERS & REVIEWS DASHBOARD -->
    <section id="dashboard-orders" class="dashboard">
      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-label">Total Orders</div>
          <div class="kpi-value" id="kpi-orders-count">–</div>
          <div class="kpi-sub">Distinct order_id (year filter applied)</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Unique Customers</div>
          <div class="kpi-value" id="kpi-orders-customers">–</div>
          <div class="kpi-sub">Orders with &gt; 2 items only</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Active Sellers</div>
          <div class="kpi-value" id="kpi-orders-sellers">–</div>
          <div class="kpi-sub">Sellers with &gt; 2 orders</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value" id="kpi-orders-revenue">–</div>
          <div class="kpi-sub">Only orders with &gt; 2 items</div>
        </div>
      </div>

      <section class="grid orders-grid">
        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Top Categories by Revenue</div>
              <div class="card-subtitle">Only categories with more than 2 orders</div>
            </div>
          </div>
          <div id="orders-top-categories" class="chart"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Top Sellers by Revenue</div>
              <div class="card-subtitle">Filtered to sellers with &gt; 2 orders</div>
            </div>
          </div>
          <div id="orders-top-sellers" class="chart"></div>
        </article>

        <article class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Orders by Year-Month</div>
              <div class="card-subtitle">Distinct orders over time (filtered by year)</div>
            </div>
          </div>
          <div id="orders-by-month" class="chart"></div>
        </article>
      </section>
    </section>
  </main>

  <script>
    /********** 1. CONFIG **********/
    const CLIENT_ID  = "297911594147-9dbblho1k834h239f7g7tfhqtr6c1gvf.apps.googleusercontent.com";
    const API_KEY    = "AIzaSyDb4uWxi5LWSQXzFvf87cJtonj6zMzNCks";
    const PROJECT_ID = "durable-ripsaw-477914-g0";

    const DIM_DATASET  = "ecommerce_dim";
    const FACT_DATASET = "ecommerce_fact";

    const SCOPES = "https://www.googleapis.com/auth/bigquery.readonly";

    const DISCOVERY_DOCS = [
      "https://bigquery.googleapis.com/$discovery/rest?version=v2"
    ];

    /********** 2. GLOBAL STATE **********/
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let selectedYear = "ALL";
    let currentTab = "customers";

    function setStatus(text, isError = false) {
      const el = document.getElementById("status");
      el.className = isError ? "error" : "";
      el.innerHTML = `<span>${text}</span>`;
    }

    /********** 3. BIGQUERY HELPER **********/
    async function runQuery(sql) {
      const request = {
        projectId: PROJECT_ID,
        resource: {
          query: sql,
          useLegacySql: false
        }
      };
      const res = await gapi.client.bigquery.jobs.query(request);
      return res.result.rows || [];
    }

    function val(row, idx) {
      return row.f[idx].v;
    }

    /********** 4. KPI HELPERS **********/
    async function loadCustomerKPIs() {
      const sql = `
        WITH base AS (
          SELECT
            f.customer_id,
            d.year,
            SUM(f.gross_order_item_value) AS revenue
          FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
          JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
            ON f.order_date_key = d.date_key
          GROUP BY customer_id, year
        )
        SELECT
          COUNT(DISTINCT customer_id) AS customers,
          COUNT(*) AS order_rows,
          COUNT(DISTINCT CONCAT(CAST(year AS STRING), ':', customer_id)) AS cust_years,
          SUM(revenue) AS total_rev
        FROM base
        ${selectedYear === "ALL" ? "" : "WHERE year = " + selectedYear}
      `;
      const rows = await runQuery(sql);
      if (!rows.length) return;
      const r = rows[0];
      document.getElementById("kpi-cust-count").textContent   = Number(val(r,0)).toLocaleString("en-US");
      document.getElementById("kpi-cust-orders").textContent  = Number(val(r,1)).toLocaleString("en-US");
      document.getElementById("kpi-cust-states").textContent  = "27";
      document.getElementById("kpi-cust-revenue").textContent = "R$ " + Number(val(r,3)).toLocaleString("en-US", {maximumFractionDigits:0});
    }

    async function loadSellerKPIs() {
      const sql = `
        WITH base AS (
          SELECT
            f.seller_id,
            s.seller_city,
            s.seller_state,
            d.year,
            SUM(f.gross_order_item_value) AS revenue
          FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
          JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_sellers\` s
            ON f.seller_id = s.seller_id
          JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
            ON f.order_date_key = d.date_key
          GROUP BY seller_id, seller_city, seller_state, year
        )
        SELECT
          COUNT(DISTINCT seller_id) AS sellers,
          COUNT(DISTINCT seller_city) AS cities,
          COUNT(DISTINCT seller_state) AS states,
          SUM(revenue) AS total_rev
        FROM base
        ${selectedYear === "ALL" ? "" : "WHERE year = " + selectedYear}
      `;
      const rows = await runQuery(sql);
      if (!rows.length) return;
      const r = rows[0];
      document.getElementById("kpi-sellers-count").textContent   = Number(val(r,0)).toLocaleString("en-US");
      document.getElementById("kpi-sellers-cities").textContent  = Number(val(r,1)).toLocaleString("en-US");
      document.getElementById("kpi-sellers-states").textContent  = Number(val(r,2)).toString();
      document.getElementById("kpi-sellers-revenue").textContent = "R$ " + Number(val(r,3)).toLocaleString("en-US", {maximumFractionDigits:0});
    }

    async function loadOrderKPIs() {
      const sql = `
        WITH base AS (
          SELECT
            f.order_id,
            f.customer_id,
            f.seller_id,
            d.year,
            COUNT(*) AS items,
            SUM(f.gross_order_item_value) AS revenue
          FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
          JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
            ON f.order_date_key = d.date_key
          GROUP BY order_id, customer_id, seller_id, year
        ),
        big_orders AS (
          SELECT * FROM base WHERE items > 2
        )
        SELECT
          COUNT(DISTINCT order_id) AS orders,
          COUNT(DISTINCT customer_id) AS customers,
          COUNT(DISTINCT seller_id) AS sellers,
          SUM(revenue) AS total_rev
        FROM big_orders
        ${selectedYear === "ALL" ? "" : "WHERE year = " + selectedYear}
      `;
      const rows = await runQuery(sql);
      if (!rows.length) return;
      const r = rows[0];
      document.getElementById("kpi-orders-count").textContent     = Number(val(r,0)).toLocaleString("en-US");
      document.getElementById("kpi-orders-customers").textContent = Number(val(r,1)).toLocaleString("en-US");
      document.getElementById("kpi-orders-sellers").textContent   = Number(val(r,2)).toLocaleString("en-US");
      document.getElementById("kpi-orders-revenue").textContent   = "R$ " + Number(val(r,3)).toLocaleString("en-US", {maximumFractionDigits:0});
    }

    /********** 5. CUSTOMER CHARTS **********/
    async function chartCustByYear() {
      const sql = `
        SELECT
          d.year,
          COUNT(DISTINCT f.customer_id) AS customers
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        GROUP BY year
        ORDER BY year
      `;
      const rows = await runQuery(sql);
      const years = rows.map(r => Number(val(r,0)));
      const custs = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("cust-by-year", [{
        type: "scatter",
        mode: "lines+markers",
        x: years,
        y: custs,
        line: { width: 3 },
        hovertemplate: "Year %{x}: %{y} customers<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 40, r: 10, b: 36 },
        xaxis: {
          title: "Year",
          color: "#9ca3af",
          gridcolor: "#111827",
          type: "category",
          tickmode: "array",
          tickvals: years,
          ticktext: years.map(String)
        },
        yaxis: { title: "Customers", color: "#9ca3af", gridcolor: "#111827" }
      }, {responsive: true});
    }

    async function chartCustTopStates() {
      const sql = `
        SELECT
          c.customer_state,
          COUNT(DISTINCT f.customer_id) AS customers
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_customers\` c
          ON f.customer_id = c.customer_id
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        ${selectedYear === "ALL" ? "" : "WHERE d.year = " + selectedYear}
        GROUP BY customer_state
        ORDER BY customers DESC
        LIMIT 5
      `;
      const rows = await runQuery(sql);
      const states = rows.map(r => val(r,0));
      const counts = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("cust-top-states", [{
        type: "bar",
        x: states,
        y: counts,
        marker: { line: { color: "#0f172a", width: 1.5 } },
        hovertemplate: "State %{x}: %{y} customers<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 36, r: 10, b: 36 },
        xaxis: { title: "State", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { title: "Customers", color: "#9ca3af", gridcolor: "#111827" }
      }, {responsive: true});
    }

    async function chartCustBottomStates() {
      const sql = `
        SELECT
          c.customer_state,
          COUNT(DISTINCT f.customer_id) AS customers
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_customers\` c
          ON f.customer_id = c.customer_id
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        ${selectedYear === "ALL" ? "" : "WHERE d.year = " + selectedYear}
        GROUP BY customer_state
        HAVING customers > 0
        ORDER BY customers ASC
        LIMIT 5
      `;
      const rows = await runQuery(sql);
      const states = rows.map(r => val(r,0));
      const counts = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("cust-bottom-states", [{
        type: "bar",
        x: counts,
        y: states,
        orientation: "h",
        marker: { line: { color: "#0f172a", width: 1.5 } },
        hovertemplate: "State %{y}: %{x} customers<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 50, r: 10, b: 30 },
        xaxis: { title: "Customers", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { color: "#9ca3af" }
      }, {responsive: true});
    }

    async function chartCustMap() {
      const stateCoords = {
        "AC": [-9.02, -70.81], "AL": [-9.57, -36.78], "AP": [1.41, -51.77],
        "AM": [-3.47, -65.10], "BA": [-12.97, -41.47], "CE": [-5.20, -39.53],
        "DF": [-15.83, -47.86], "ES": [-19.19, -40.34], "GO": [-16.64, -49.31],
        "MA": [-5.42, -45.44], "MT": [-12.64, -55.42], "MS": [-20.44, -54.64],
        "MG": [-18.10, -44.38], "PA": [-3.79, -52.48], "PB": [-7.24, -36.78],
        "PR": [-25.25, -52.02], "PE": [-8.81, -36.95], "PI": [-7.72, -42.73],
        "RJ": [-22.91, -43.20], "RN": [-5.80, -36.59], "RS": [-30.03, -51.22],
        "RO": [-11.22, -62.80], "RR": [1.90, -61.13], "SC": [-27.33, -49.44],
        "SP": [-23.55, -46.63], "SE": [-10.57, -37.45], "TO": [-10.18, -48.33]
      };

      const sql = `
        SELECT
          c.customer_state,
          COUNT(DISTINCT f.customer_id) AS customers
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_customers\` c
          ON f.customer_id = c.customer_id
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        ${selectedYear === "ALL" ? "" : "WHERE d.year = " + selectedYear}
        GROUP BY customer_state
      `;
      const rows = await runQuery(sql);

      const lats  = [];
      const lngs  = [];
      const sizes = [];
      const texts = [];
      const colors = [];

      let maxCust = 0;
      rows.forEach(r => {
        const st = val(r,0);
        const c  = Number(val(r,1));
        if (!stateCoords[st]) return;
        if (c > maxCust) maxCust = c;
      });

      rows.forEach(r => {
        const st = val(r,0);
        const c  = Number(val(r,1));
        if (!stateCoords[st]) return;
        const [lat, lng] = stateCoords[st];
        lats.push(lat);
        lngs.push(lng);
        sizes.push(12 + (c / maxCust) * 40);
        texts.push(`${st}: ${c.toLocaleString("en-US")} customers`);
        colors.push(c);
      });

      Plotly.newPlot("cust-map", [{
        type: "scattergeo",
        lat: lats,
        lon: lngs,
        mode: "markers",
        marker: {
          size: sizes,
          sizemode: "diameter",
          opacity: 0.95,
          color: colors,
          colorscale: [
            [0,   "#0ea5e9"],
            [0.5, "#22d3ee"],
            [1,   "#2dd4bf"]
          ],
          line: { width: 1.5, color: "#020617" }
        },
        hovertemplate: "%{text}<extra></extra>",
        text: texts
      }], {
        geo: {
          scope: "south america",
          projection: { type: "mercator" },
          center: { lat: -14.235, lon: -51.9253 },
          lonaxis: { range: [-85, -30] },
          lataxis: { range: [-35, 10] },
          showland: true,
          landcolor: "#020617",
          showocean: true,
          oceancolor: "#020617",
          showcountries: true,
          countrycolor: "#1f2937",
          subunitcolor: "#1f2937"
        },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 10, l: 0, r: 0, b: 0 }
      }, {responsive: true});
    }

    async function renderCustomerDashboard() {
      await Promise.all([
        loadCustomerKPIs(),
        chartCustByYear(),
        chartCustTopStates(),
        chartCustBottomStates(),
        chartCustMap()
      ]);
    }

    /********** 6. SELLER CHARTS **********/
    async function chartSellerFreightYear() {
      const sql = `
        SELECT
          d.year,
          SUM(f.freight_value) AS freight
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        GROUP BY year
        ORDER BY year
      `;
      const rows = await runQuery(sql);
      const years = rows.map(r => Number(val(r,0)));
      const freight = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("seller-freight-year", [{
        type: "pie",
        labels: years,
        values: freight,
        hole: 0.65,
        hovertemplate: "Year %{label}: R$ %{value:,.0f}<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 4, r: 4, b: 4 },
        showlegend: true,
        legend: { font: { color: "#9ca3af" } }
      }, {responsive: true});
    }

    async function chartSellerRevenueYear() {
      const sql = `
        SELECT
          d.year,
          SUM(f.gross_order_item_value) AS revenue
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        GROUP BY year
        ORDER BY year
      `;
      const rows = await runQuery(sql);
      const years = rows.map(r => Number(val(r,0)));
      const rev   = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("seller-revenue-year", [{
        type: "scatter",
        mode: "lines+markers",
        x: years,
        y: rev,
        line: { width: 3 },
        hovertemplate: "Year %{x}: R$ %{y:,.0f}<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 48, r: 10, b: 36 },
        xaxis: {
          title: "Year",
          color: "#9ca3af",
          gridcolor: "#111827",
          type: "category",
          tickmode: "array",
          tickvals: years,
          ticktext: years.map(String)
        },
        yaxis: { title: "Revenue (BRL)", color: "#9ca3af", gridcolor: "#111827" }
      }, {responsive: true});
    }

    async function chartSellerTopStates() {
      const sql = `
        SELECT
          s.seller_state,
          COUNT(DISTINCT s.seller_id) AS sellers
        FROM \`${PROJECT_ID}.${DIM_DATASET}.dim_db_sellers\` s
        GROUP BY seller_state
        ORDER BY sellers DESC
        LIMIT 10
      `;
      const rows = await runQuery(sql);
      const states = rows.map(r => val(r,0));
      const sellers = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("seller-top-states", [{
        type: "bar",
        orientation: "h",
        y: states,
        x: sellers,
        hovertemplate: "State %{y}: %{x} sellers<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 70, r: 10, b: 28 },
        xaxis: { title: "Number of sellers", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { color: "#9ca3af" }
      }, {responsive: true});
    }

    async function chartSellerBottomStates() {
      const sql = `
        SELECT
          s.seller_state,
          COUNT(DISTINCT s.seller_id) AS sellers
        FROM \`${PROJECT_ID}.${DIM_DATASET}.dim_db_sellers\` s
        GROUP BY seller_state
        HAVING sellers > 0
        ORDER BY sellers ASC
        LIMIT 10
      `;
      const rows = await runQuery(sql);
      const states = rows.map(r => val(r,0));
      const sellers = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("seller-bottom-states", [{
        type: "bar",
        orientation: "h",
        y: states,
        x: sellers,
        hovertemplate: "State %{y}: %{x} sellers<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 70, r: 10, b: 28 },
        xaxis: { title: "Number of sellers", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { color: "#9ca3af" }
      }, {responsive: true});
    }

    async function chartSellerCategoryBreadth() {
      const sql = `
        SELECT
          COALESCE(p.product_category_name_english, p.product_category_name) AS category,
          COUNT(*) AS items
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_products\` p
          ON f.product_id = p.product_id
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        ${selectedYear === "ALL" ? "" : "WHERE d.year = " + selectedYear}
        GROUP BY category
        HAVING items > 2
        ORDER BY items DESC
        LIMIT 25
      `;
      const rows = await runQuery(sql);
      const data = rows.map(r => ({
        cat: val(r,0) || "Unknown",
        cnt: Number(val(r,1))
      })).sort((a, b) => a.cnt - b.cnt);

      Plotly.newPlot("seller-category-breadth", [{
        type: "bar",
        orientation: "h",
        y: data.map(d => d.cat),
        x: data.map(d => d.cnt),
        hovertemplate: "%{y}: %{x} order items<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 120, r: 10, b: 28 },
        xaxis: { title: "Order items (> 2)", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { color: "#9ca3af" }
      }, {responsive: true});
    }

    async function renderSellerDashboard() {
      await Promise.all([
        loadSellerKPIs(),
        chartSellerFreightYear(),
        chartSellerRevenueYear(),
        chartSellerTopStates(),
        chartSellerBottomStates(),
        chartSellerCategoryBreadth()
      ]);
    }

    /********** 7. ORDER CHARTS **********/
    async function chartOrdersTopCategories() {
      const sql = `
        WITH base AS (
          SELECT
            d.year,
            COALESCE(p.product_category_name_english, p.product_category_name) AS category,
            COUNT(DISTINCT f.order_id) AS orders,
            SUM(f.gross_order_item_value) AS revenue
          FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
          JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_products\` p
            ON f.product_id = p.product_id
          JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
            ON f.order_date_key = d.date_key
          GROUP BY year, category
        )
        SELECT
          category,
          SUM(revenue) AS revenue
        FROM base
        WHERE orders > 2
        ${selectedYear === "ALL" ? "" : "AND year = " + selectedYear}
        GROUP BY category
        ORDER BY revenue DESC
        LIMIT 15
      `;
      const rows = await runQuery(sql);
      const cats = rows.map(r => val(r,0) || "Unknown");
      const revs = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("orders-top-categories", [{
        type: "bar",
        orientation: "h",
        y: cats.reverse(),
        x: revs.reverse(),
        hovertemplate: "%{y}: R$ %{x:,.0f}<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 135, r: 10, b: 30 },
        xaxis: { title: "Revenue (BRL, > 2 orders)", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { color: "#9ca3af" }
      }, {responsive: true});
    }

    async function chartOrdersTopSellers() {
      const sql = `
        WITH base AS (
          SELECT
            d.year,
            f.seller_id,
            COALESCE(s.seller_id, f.seller_id) AS seller_label,
            COUNT(DISTINCT f.order_id) AS orders,
            SUM(f.gross_order_item_value) AS revenue
          FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
          JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
            ON f.order_date_key = d.date_key
          LEFT JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_sellers\` s
            ON f.seller_id = s.seller_id
          GROUP BY year, seller_id, seller_label
        )
        SELECT
          seller_label,
          SUM(revenue) AS revenue
        FROM base
        WHERE orders > 2
        ${selectedYear === "ALL" ? "" : "AND year = " + selectedYear}
        GROUP BY seller_label
        ORDER BY revenue DESC
        LIMIT 15
      `;
      const rows = await runQuery(sql);
      const labels = rows.map(r => val(r,0) || "Unknown");
      const revs   = rows.map(r => Number(val(r,1)));

      Plotly.newPlot("orders-top-sellers", [{
        type: "bar",
        x: revs,
        y: labels,
        orientation: "h",
        hovertemplate: "%{y}: R$ %{x:,.0f}<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 120, r: 10, b: 30 },
        xaxis: { title: "Revenue (BRL, > 2 orders)", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { color: "#9ca3af" }
      }, {responsive: true});
    }

    async function chartOrdersByMonth() {
      const sql = `
        SELECT
          d.year,
          d.year_month,
          COUNT(DISTINCT f.order_id) AS orders
        FROM \`${PROJECT_ID}.${FACT_DATASET}.fact_db_order_items\` f
        JOIN \`${PROJECT_ID}.${DIM_DATASET}.dim_db_dates\` d
          ON f.order_date_key = d.date_key
        GROUP BY year, year_month
        HAVING COUNT(DISTINCT f.order_id) > 1
        ORDER BY year_month
      `;
      const rows = await runQuery(sql);
      let filtered = rows;
      if (selectedYear !== "ALL") {
        filtered = rows.filter(r => Number(val(r,0)) === Number(selectedYear));
      }
      const months = filtered.map(r => val(r,1));
      const counts = filtered.map(r => Number(val(r,2)));

      Plotly.newPlot("orders-by-month", [{
        type: "scatter",
        mode: "lines+markers",
        x: months,
        y: counts,
        line: { width: 2.6 },
        hovertemplate: "%{x}: %{y} orders<extra></extra>"
      }], {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        margin: { t: 12, l: 48, r: 10, b: 40 },
        xaxis: { title: "Year-Month", color: "#9ca3af", gridcolor: "#111827" },
        yaxis: { title: "Orders", color: "#9ca3af", gridcolor: "#111827" }
      }, {responsive: true});
    }

    async function renderOrderDashboard() {
      await Promise.all([
        loadOrderKPIs(),
        chartOrdersTopCategories(),
        chartOrdersTopSellers(),
        chartOrdersByMonth()
      ]);
    }

    /********** 8. RENDER CURRENT TAB **********/
    async function renderCurrentDashboard() {
      if (currentTab === "customers") {
        await renderCustomerDashboard();
      } else if (currentTab === "sellers") {
        await renderSellerDashboard();
      } else if (currentTab === "orders") {
        await renderOrderDashboard();
      }
      setStatus(`Dashboard ready. Year filter: ${selectedYear === "ALL" ? "All" : selectedYear}.`);
    }

    /********** 9. AUTH & INIT **********/
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: () => {}
      });
      gisInited = true;
      maybeEnableSignin();
    }

    function gapiLoaded() {
      gapi.load("client", async () => {
        try {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS
          });
          gapiInited = true;
          maybeEnableSignin();
        } catch (err) {
          console.error("Init error:", err);
          setStatus("Error initialising Google client. Check API Key / Client ID.", true);
        }
      });
    }

    function maybeEnableSignin() {
      if (gapiInited && gisInited) {
        const btn = document.getElementById("signin-button");
        btn.disabled = false;
        setStatus("Google client ready. Sign in to load live metrics.");
      }
    }

    window.addEventListener("load", () => {
      if (typeof gapi !== "undefined") {
        gapiLoaded();
      } else {
        setStatus("Failed to load Google API JS.", true);
      }

      // Wait for GIS script to be ready
      const gisInterval = setInterval(() => {
        if (window.google && google.accounts && google.accounts.oauth2) {
          clearInterval(gisInterval);
          if (!gisInited) gisLoaded();
        }
      }, 200);

      const signInBtn  = document.getElementById("signin-button");
      const signOutBtn = document.getElementById("signout-button");

      signInBtn.onclick = () => {
        if (!tokenClient) {
          setStatus("Auth client not ready yet. Try again in a few seconds.", true);
          return;
        }
        tokenClient.callback = (resp) => {
          if (resp.error) {
            console.error(resp);
            const msg =
              resp?.error_description ||
              resp?.error ||
              "Error getting access token.";
            setStatus(msg, true);
            return;
          }
          signInBtn.style.display  = "none";
          signOutBtn.style.display = "inline-flex";
          setStatus("Signed in. Running BigQuery queries…");
          renderCurrentDashboard().catch(err => {
            console.error("Query error:", err);
            const msg =
              err?.result?.error?.message ||
              err?.message ||
              "Error running queries for selected year.";
            setStatus(msg, true);
          });
        };
        tokenClient.requestAccessToken({ prompt: "consent" });
      };

      signOutBtn.onclick = () => {
        const token = gapi.client.getToken();
        if (token && token.access_token) {
          google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken(null);
            signOutBtn.style.display = "none";
            signInBtn.style.display  = "inline-flex";
            setStatus("Signed out. Sign in again to refresh the dashboard.");
          });
        }
      };

      // Tab switching
      document.querySelectorAll(".tab-pill").forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          currentTab = tab;

          document.querySelectorAll(".tab-pill").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          document.querySelectorAll(".dashboard").forEach(d => d.classList.remove("active"));
          document.getElementById(`dashboard-${tab}`).classList.add("active");

          if (gapi.client && gapi.client.getToken()) {
            setStatus(`Loading ${tab} dashboard…`);
            renderCurrentDashboard().catch(err => {
              console.error("Query error:", err);
              const msg =
                err?.result?.error?.message ||
                err?.message ||
                "Error running queries for selected year.";
              setStatus(msg, true);
            });
          }
        });
      });

      // Year slicer
      document.querySelectorAll(".year-pill").forEach(btn => {
        btn.addEventListener("click", () => {
          selectedYear = btn.dataset.year;
          document.querySelectorAll(".year-pill").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");

          if (gapi.client && gapi.client.getToken()) {
            setStatus(`Reloading charts for year: ${selectedYear === "ALL" ? "All" : selectedYear}…`);
            renderCurrentDashboard().catch(err => {
              console.error("Query error:", err);
              const msg =
                err?.result?.error?.message ||
                err?.message ||
                "Error running queries for selected year.";
              setStatus(msg, true);
            });
          }
        });
      });
    });
  </script>
</body>
</html>

